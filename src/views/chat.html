<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Window</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
      body {
        overflow: hidden;
      }

      /* Chat messages */
      .message {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 18px;
        font-size: 0.9rem;
        margin-bottom: 12px;
        position: relative;
        line-height: 1.4;

        /* ✅ Wrapping fixes */
        word-break: break-word;         /* break long words */
        overflow-wrap: anywhere;        /* force wrap on tablets */
        white-space: pre-wrap;          /* respect new lines but wrap long text */
      }
      .message.sent {
        background: #dbeafe;
        margin-left: auto;
        text-align: left;
      }
      .message.received {
        background: #fff;
        border: 1px solid #e5e7eb;
        margin-right: auto;
        text-align: left;
      }
      .timestamp {
        font-size: 0.7rem;
        color: #6b7280;
        display: block;
        margin-top: 3px;
        text-align: right;
      }

      /* Sidebar */
      #sidebar {
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease;
      }
      .sidebar-header {
        background: #0d6efd;
        color: #fff;
        font-weight: 600;
        padding: 12px;
        text-align: center;
      }
      .group-btn {
        border-radius: 0;
        font-weight: 500;
      }
      .user-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px;
        cursor: pointer;
        border-radius: 8px;
        transition: background 0.2s;
      }
      .user-item:hover {
        background: #f3f4f6;
      }
      .user-avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: #0d6efd;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 600;
        flex-shrink: 0;
      }
      .user-details {
        display: flex;
        flex-direction: column;
      }
      .user-name {
        font-weight: 600;
        font-size: 14px;
      }
      .user-mobile {
        font-size: 12px;
        color: #6b7280;
      }

      /* Chat section */
      #chatSection {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      #chatMessages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background: #f9fafb;
      }
      .chat-input {
        border-top: 1px solid #e5e7eb;
        background: #fff;
        padding: 8px 12px;
      }
      .chat-input .form-control {
        flex: 1;
        border-radius: 25px;
      }
      .chat-input .btn {
        border-radius: 25px;
      }

      /* Mobile Sidebar Toggle */
      #menuToggle {
        display: none;
        cursor: pointer;
        font-size: 1.5rem;
      }
      .message img, .message video {
        display: block;
        margin-top: 5px;
        border-radius: 12px;
        object-fit: cover; /* keeps aspect ratio nicely */
      }

      @media (max-width: 768px) {
        #sidebar {
          position: fixed;
          top: 0;
          left: 0;
          height: 100%;
          width: 70%;
          background: white;
          z-index: 1051;
          transform: translateX(-100%);
        }
        #sidebar.show {
          transform: translateX(0);
        }
        #menuToggle {
          display: block;
        }
        #backdrop {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1050;
        }
        #backdrop.show {
          display: block;
        }
      }
    </style>
  </head>

  <body class="vh-100">
    <div class="container-fluid h-100">
      <div class="row h-100">
        <!-- Sidebar -->
        <div class="col-12 col-md-3 col-lg-3 bg-white p-0" id="sidebar">
          <div class="sidebar-header">All Chats</div>

          <button
            class="btn btn-outline-primary w-100 group-btn"
            id="goToGroups"
          >
            <i class="bi bi-people"></i> Go to Groups
          </button>

          <ul
            class="list-unstyled flex-grow-1 overflow-auto mb-0 px-2 user-list"
            id="userList"
          ></ul>

          <div class="p-2 border-top">
            <input
              type="tel"
              class="form-control mb-2"
              id="addNumber"
              placeholder="Add new number..."
            />
            <button class="btn btn-primary w-100" id="addBtn">Add</button>
          </div>
        </div>

        <!-- Chat Section -->
        <div class="col d-flex flex-column p-0" id="chatSection">
          <div
            class="d-flex justify-content-between align-items-center bg-primary text-white p-2"
          >
            <i class="bi bi-list" id="menuToggle"></i>
            <span id="chatHeader">Select a user to start chat</span>
            <span></span>
          </div>

          <div id="chatMessages">
            <div class="text-muted text-center mt-5">
              No messages yet. Start the conversation!
            </div>
          </div>

          <!-- Input -->
          <div class="chat-input d-flex align-items-center gap-2">
            <!-- Hidden file input -->
            <input type="file" id="mediaInput" style="display: none;" />

            <!-- Label as icon button to open file selector -->
            <label for="mediaInput" class="btn btn-light p-2" id="attachBtn" title="Attach media">
              <i class="bi bi-paperclip"></i>
            </label>

            <!-- Text input -->
            <input
              type="text"
              id="messageInput"
              class="form-control"
              placeholder="Type a message..."
            />

            <!-- Send button -->
            <button class="btn btn-primary px-3" id="sendBtn">
              <i class="bi bi-send text-white" id="sendIcon"></i>
            </button>
          </div>

        </div>
      </div>
    </div>

    <!-- Backdrop for mobile -->
    <div id="backdrop"></div>

    <script>
      // Sidebar toggle on mobile
      const menuToggle = document.getElementById("menuToggle");
      const sidebar = document.getElementById("sidebar");
      const backdrop = document.getElementById("backdrop");
      const mediaInput = document.getElementById("mediaInput");
      const sendIcon = document.getElementById("sendIcon");
      const messageInput = document.getElementById("messageInput");

      // Change send icon if file selected
      mediaInput.addEventListener("change", () => {
        if (mediaInput.files.length > 0) {
          sendIcon.className = "bi bi-file-earmark-arrow-up text-white"; // file upload icon
        } else {
          sendIcon.className = "bi bi-send text-white"; // default send icon
        }
      });

      // Reset icon when text input is cleared
      messageInput.addEventListener("input", () => {
        if (messageInput.value.trim() !== "") {
          sendIcon.className = "bi bi-send text-white";
        } else if (mediaInput.files.length > 0) {
          sendIcon.className = "bi bi-file-earmark-arrow-up text-white";
        } else {
          sendIcon.className = "bi bi-send text-white";
        }
      });

      // Trigger send on click or Enter
      document.getElementById("sendBtn").addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendMessage();
        }
      });


      menuToggle.addEventListener("click", () => {
        sidebar.classList.add("show");
        backdrop.classList.add("show");
      });

      backdrop.addEventListener("click", () => {
        sidebar.classList.remove("show");
        backdrop.classList.remove("show");
      });

      // 🔹 Redirect to group chat page
      document.getElementById("goToGroups").addEventListener("click", () => {
        window.location.href = "/group"; // this matches your server route
      });

      const token = sessionStorage.getItem("token");
      let selectedUserId = null;
      const chatMessages = document.getElementById("chatMessages");
      const userList = document.getElementById("userList");
      const chatHeader = document.getElementById("chatHeader");

      // ✅ Connect WebSocket with token
      const socket = io("http://localhost:3000", {
        auth: { token },
      });

      socket.on("connect", () => {
        console.log("✅ Connected to WebSocket");
        // if (getUserId()) {
        //   socket.emit("join", { userId: getUserId() });
        // }
      });

      // 📩 Listen for new messages with media
      socket.on("message", (msg) => {
        if (
          (msg.senderId === selectedUserId && msg.receiverId === getUserId()) ||
          (msg.senderId === getUserId() && msg.receiverId === selectedUserId)
        ) {
          const type = msg.senderId === getUserId() ? "sent" : "received";
          addMessage(msg.content, type, msg.createdAt, msg.mediaUrl || null);
        }
      });

      // 🆔 Extract userId from JWT
      function getUserId() {
        if (!token) return null;
        try {
          return JSON.parse(atob(token.split(".")[1])).id;
        } catch {
          return null;
        }
      }

      // 🕒 Format timestamp
      function formatTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function addMessage(content, type = "sent", timestamp = new Date(), mediaUrl = null) {
        const placeholder = chatMessages.querySelector(".text-muted");
        if (placeholder) placeholder.remove();

        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message", type);

        let mediaHTML = "";
        if (mediaUrl) {
          const ext = mediaUrl.split(".").pop().toLowerCase();
          const fileName = mediaUrl.split("/").pop();

          if (["png","jpg","jpeg","gif"].includes(ext)) {
            mediaHTML = `<img src="${mediaUrl}" 
                              style="max-width:250px; max-height:250px; width:auto; height:auto; border-radius:12px; margin-top:5px;"
                              loading="lazy">`;
          } else if (["mp4","webm","ogg"].includes(ext)) {
            mediaHTML = `<video controls 
                              style="max-width:300px; max-height:300px; border-radius:12px; margin-top:5px;"
                              preload="metadata">
                          <source src="${mediaUrl}" type="video/${ext}">
                        </video>`;
          } else if (ext === "pdf") {
            mediaHTML = `<a href="${mediaUrl}" target="_blank">📄 ${fileName}</a>`;
          } else {
            mediaHTML = `<a href="${mediaUrl}" target="_blank">${fileName}</a>`;
          }
        }

        msgDiv.innerHTML = `${content ? `<span>${content}</span>` : ""}${mediaHTML}<span class="timestamp">${formatTime(timestamp)}</span>`;
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }



      // 📂 Load all contacts
      async function loadContacts() {
        try {
          const res = await fetch("http://localhost:3000/api/contacts/all", {
            headers: { Authorization: "Bearer " + token },
          });
          const contacts = await res.json();

          userList.innerHTML = "";
          contacts.forEach((c) => {
            const li = document.createElement("li");
            li.classList.add("user-item");
            li.innerHTML = `
              <div class="user-avatar">${c.ContactUser.name[0].toUpperCase()}</div>
              <div class="user-details">
                <span class="user-name">${c.ContactUser.name}</span>
                <span class="user-mobile">91-${c.ContactUser.mobile}</span>
              </div>
            `;
            li.addEventListener("click", () =>
              selectUser(c.ContactUser.id, c.ContactUser.name)
            );
            userList.appendChild(li);
          });
        } catch (err) {
          console.error("❌ Error loading contacts:", err);
        }
      }

      // 👤 Select user from sidebar
      function selectUser(userId, userName) {
        selectedUserId = userId;
        chatHeader.textContent = userName;
        loadMessages();

        sidebar.classList.remove("show");
        backdrop.classList.remove("show");
      }

      // 📥 Load messages from API
      async function loadMessages() {
        if (!selectedUserId) return;

        try {
          const res = await fetch(
            `http://localhost:3000/api/messages/conversation/${selectedUserId}`,
            { headers: { Authorization: "Bearer " + token } }
          );
          const messages = await res.json();
          chatMessages.innerHTML = "";
          if (messages.length === 0) {
            chatMessages.innerHTML = `<div class="text-muted text-center mt-5">No messages yet. Start the conversation!</div>`;
          } else {
            messages.forEach((msg) => {
              const type = msg.senderId === getUserId() ? "sent" : "received";
              addMessage(msg.content, type, msg.createdAt, msg.mediaUrl || null);
            });
          }
        } catch (err) {
          console.error("❌ Error loading messages:", err);
        }
      }

let sending = false;

async function sendMessage() {
  if (sending) return;
  sending = true;

  if (!selectedUserId) return alert("Select a user to chat!");

  const textContent = messageInput.value.trim();
  const file = mediaInput.files[0];

  if (!textContent && !file) { sending = false; return; }

  try {
    let payload;
    if (file) {
      const formData = new FormData();
      formData.append("receiverId", selectedUserId);
      formData.append("media", file);
      if (textContent) formData.append("content", textContent);

      const res = await fetch("http://localhost:3000/api/messages/send-media", {
        method: "POST",
        headers: { Authorization: "Bearer " + token },
        body: formData,
      });
      payload = await res.json();
    } else {
      const res = await fetch("http://localhost:3000/api/messages/send", {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify({ receiverId: selectedUserId, content: textContent }),
      });
      payload = await res.json();
    }

    addMessage(payload.content || "", "sent", payload.createdAt || new Date(), payload.mediaUrl || null);

    socket.emit("newMessage", {
      receiverId: selectedUserId,
      content: payload.content || "",
      mediaUrl: payload.mediaUrl || null,
      createdAt: payload.createdAt || new Date(),
    });

    messageInput.value = "";
    mediaInput.value = "";
  } catch (err) {
    console.error("Error sending message:", err);
  } finally {
    sending = false;
  }
}

      document.getElementById("sendBtn").addEventListener("click", sendMessage);
      document
        .getElementById("messageInput")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
          }
        });

      document.getElementById("addBtn").addEventListener("click", async () => {
        const input = document.getElementById("addNumber");
        const mobile = input.value.trim();
        if (!mobile) return;

        try {
          const res = await fetch("http://localhost:3000/api/contacts/add", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({ mobile }),
          });

          const data = await res.json();

          // Remove message after 2 seconds
          setTimeout(() => msgDiv.remove(), 2000);

          // ✅ Reset input and focus
          input.value = "";
          input.focus();

          // Reload contacts
          loadContacts();
        } catch (err) {
          console.error("❌ Error adding contact:", err);

          // Show inline error message
          const msgDiv = document.createElement("div");
          msgDiv.className = "alert alert-danger mt-2";
          msgDiv.innerText = "Failed to add contact. Try again!";
          input.parentNode.appendChild(msgDiv);
          setTimeout(() => msgDiv.remove(), 2000);
        }
      });

      // 🚀 Init
      loadContacts();
    </script>
  </body>
</html>
