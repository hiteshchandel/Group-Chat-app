<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Group Chat - Chat Window</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      .message {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 18px;
        font-size: 0.9rem;
        word-wrap: break-word;
        margin-bottom: 12px;
        position: relative;
      }

      .message.sent {
        background: #dbeafe;
        margin-left: auto;
      }

      .message.received {
        background: #fff;
        border: 1px solid #e5e7eb;
        margin-right: auto;
      }

      .timestamp {
        font-size: 0.7rem;
        color: #6b7280;
        display: block;
        margin-top: 3px;
        text-align: right;
      }

      @media (max-width: 768px) {
        #sidebar {
          position: absolute;
          height: 100%;
          transform: translateX(-100%);
          z-index: 1000;
          transition: transform 0.3s ease;
        }

        #sidebar.show {
          transform: translateX(0);
        }

        #menuToggle {
          display: inline-block !important;
        }
      }
    </style>
  </head>

  <body class="vh-100">
    <div class="container-fluid h-100">
      <div class="row h-100">
        <!-- Sidebar -->
        <div
          class="col-12 col-md-3 col-lg-3 bg-white border-end d-flex flex-column p-0"
          id="sidebar"
        >
          <div class="bg-primary text-white text-center fw-semibold py-2">
            All Chats
          </div>

          <div class="p-2 border-bottom">
            <input
              type="search"
              class="form-control rounded-pill"
              placeholder="Search user..."
            />
          </div>

          <div class="p-2 border-bottom">
            <a href="group.html" class="btn btn-outline-primary w-100"
              >Go to Groups</a
            >
          </div>

          <ul
            class="list-unstyled flex-grow-1 overflow-auto mb-0 px-2 user-list"
          ></ul>

          <div class="p-2 border-top">
            <input
              type="tel"
              class="form-control mb-2"
              id="addNumber"
              placeholder="Add new number..."
            />
            <button class="btn btn-primary w-100">Add</button>
          </div>
        </div>

        <!-- Chat Section -->
        <div class="col bg-light d-flex flex-column p-0">
          <!-- Header -->
          <div
            class="d-flex justify-content-between align-items-center bg-primary text-white p-2"
          >
            <span>
              <i class="bi bi-list me-2 d-none" id="menuToggle"></i>
              User Details...
            </span>
            <i class="bi bi-three-dots-vertical"></i>
          </div>

          <!-- Messages -->
          <div class="flex-grow-1 overflow-auto p-3" id="chatMessages">
            <div class="text-muted text-center mt-5">
              No messages yet. Start the conversation!
            </div>
          </div>

          <!-- Input -->
          <div class="d-flex align-items-center gap-2 p-2 border-top bg-white">
            <label for="fileUpload" class="fs-5 text-primary mb-0"
              ><i class="bi bi-paperclip"></i
            ></label>
            <input type="file" id="fileUpload" hidden />
            <input
              type="text"
              id="messageInput"
              class="form-control rounded-pill"
              placeholder="Type a message..."
            />
            <button class="btn btn-primary rounded-pill px-3" id="sendBtn">
              <i class="bi bi-send text-white"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const sendBtn = document.getElementById("sendBtn");
      const messageInput = document.getElementById("messageInput");
      const chatMessages = document.getElementById("chatMessages");
      const menuToggle = document.getElementById("menuToggle");
      const sidebar = document.getElementById("sidebar");
      const fileUpload = document.getElementById("fileUpload");

      // 🛠 Replace this with your real token (store after login in localStorage/sessionStorage)
      const token = localStorage.getItem("token");

      // Format timestamp
      function formatTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // Add a message
      function addMessage(text, type = "sent", timestamp = new Date()) {
        const placeholder = chatMessages.querySelector(".text-muted");
        if (placeholder) placeholder.remove();

        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message", type);
        msgDiv.innerHTML = `
      <span>${text}</span>
      <span class="timestamp">${formatTime(timestamp)}</span>
    `;
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Load messages from DB
      async function loadMessages() {
        try {
          const res = await fetch("/api/chat/all", {
            headers: { Authorization: "Bearer " + token },
          });
          const data = await res.json();

          chatMessages.innerHTML = ""; // clear old
          if (data.length === 0) {
            chatMessages.innerHTML = `<div class="text-muted text-center mt-5">No messages yet. Start the conversation!</div>`;
          } else {
            data.forEach((msg) => {
              const type =
                msg.User && msg.User.id == getUserId() ? "sent" : "received";
              addMessage(msg.message, type, msg.createdAt);
            });
          }
        } catch (err) {
          console.error("❌ Error loading messages:", err);
        }
      }

      // Get user ID from token (assuming JWT payload contains id)
      function getUserId() {
        try {
          const payload = JSON.parse(atob(token.split(".")[1]));
          return payload.id;
        } catch {
          return null;
        }
      }

      // Send message to backend
      async function sendMessage(text) {
        try {
          const res = await fetch("/api/chat/send", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({ message: text }),
          });

          if (!res.ok) throw new Error("Failed to send");

          const data = await res.json();
          addMessage(data.data.message, "sent", data.data.createdAt);
        } catch (err) {
          console.error("❌ Error sending message:", err);
        }
      }

      // Send message button
      sendBtn.addEventListener("click", () => {
        const text = messageInput.value.trim();
        if (text) {
          sendMessage(text);
          messageInput.value = "";
        }
      });

      // Enter key
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendBtn.click();
      });

      // Toggle sidebar
      menuToggle.addEventListener("click", () => {
        sidebar.classList.toggle("show");
      });

      // File upload preview (not saved to DB yet)
      fileUpload.addEventListener("change", (e) => {
        if (e.target.files.length) {
          addMessage(`📎 ${e.target.files[0].name}`, "sent");
        }
      });

      // Load chat history on page load
      loadMessages();
    </script>
  </body>
</html>
