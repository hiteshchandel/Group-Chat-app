<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SeaTalk - Groups</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      body {
        overflow: hidden;
        font-family: system-ui, sans-serif;
      }

      /* Sidebar */
      #sidebar {
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease;
      }
      .sidebar-header {
        background: #0d6efd;
        color: #fff;
        font-weight: 600;
        padding: 12px;
        text-align: center;
      }
      .group-item {
        background: #f8f9fa;
        padding: 10px;
        margin: 5px 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .group-item:hover {
        background: #e9ecef;
      }

      /* Chat section */
      #chatSection {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      #chatMessages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background: #f9fafb;
      }
      .message {
        display: flex;
        flex-direction: column;
        max-width: 70%;
        padding: 6px 10px;
        border-radius: 12px;
        margin-bottom: 6px;
        font-size: 0.9rem;
        line-height: 1.3;
      }

      .bubble {
        display: inline-block; /* keeps bubble tight around text */
        max-width: 100%; /* max width inside .message */
        word-wrap: break-word; /* break long words */
        white-space: normal; /* allow line wrapping */
        line-height: 1.3;
      }

      .message.sent {
        background: #dbeafe;
        margin-left: auto;
      }
      .message.received {
        background: #fff;
        border: 1px solid #e5e7eb;
        margin-right: auto;
      }
      .timestamp {
        font-size: 0.7rem;
        color: #6b7280;
        display: block;
        margin-top: 3px;
        text-align: right;
      }

      /* Input */
      .chat-input {
        border-top: 1px solid #e5e7eb;
        background: #fff;
        padding: 8px 12px;
      }
      .chat-input .form-control {
        flex: 1;
        border-radius: 25px;
      }
      .chat-input .btn {
        border-radius: 25px;
      }

      /* Mobile Sidebar */
      #menuToggle {
        display: none;
        cursor: pointer;
        font-size: 1.5rem;
      }
      @media (max-width: 768px) {
        #sidebar {
          position: fixed;
          top: 0;
          left: 0;
          height: 100%;
          width: 70%;
          background: white;
          z-index: 1051;
          transform: translateX(-100%);
        }
        #sidebar.show {
          transform: translateX(0);
        }
        #menuToggle {
          display: block;
        }
        #backdrop {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1050;
        }
        #backdrop.show {
          display: block;
        }
      }

      /* Member Modal */
      #memberModal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        z-index: 2000;
        width: 300px;
      }
      #memberModal h5 {
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body class="vh-100">
    <div class="container-fluid h-100">
      <div class="row h-100">
        <!-- Sidebar -->
        <div class="col-12 col-md-3 col-lg-3 bg-white p-0" id="sidebar">
          <div class="sidebar-header">SeaTalk Groups</div>
          <ul
            class="list-unstyled flex-grow-1 overflow-auto mb-0"
            id="groupsList"
          ></ul>

          <div class="p-2 border-top">
            <h6 class="fw-bold">Create Group</h6>
            <form id="createGroupForm" class="d-flex flex-column gap-2">
              <input
                type="text"
                id="groupName"
                class="form-control"
                placeholder="Group name..."
                required
              />
              <div
                id="createGroupMembersCheckboxes"
                class="mb-2"
                style="max-height: 200px; overflow: auto"
              ></div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> Create Group
              </button>
            </form>
          </div>
        </div>

        <!-- Chat Section -->
        <div class="col d-flex flex-column p-0" id="chatSection">
          <div
            class="d-flex justify-content-between align-items-center bg-primary text-white p-2"
          >
            <i class="bi bi-list" id="menuToggle"></i>
            <span id="chatHeader">Select a group to start chat</span>
            <div id="adminActions" style="display: none">
              <button
                class="btn btn-sm btn-light me-1"
                id="addMemberBtn"
                title="Add Member"
              >
                <i class="bi bi-person-plus"></i>
              </button>
              <button
                class="btn btn-sm btn-light me-1"
                id="removeMemberBtn"
                title="Remove Member"
              >
                <i class="bi bi-person-dash"></i>
              </button>
              <button
                class="btn btn-sm btn-light"
                id="makeAdminBtn"
                title="Make Admin"
              >
                <i class="bi bi-shield-check"></i>
              </button>
            </div>
          </div>

          <div id="chatMessages" class="flex-grow-1">
            <div class="text-muted text-center mt-5">
              No messages yet. Start chatting!
            </div>
          </div>

          <!-- Input -->
          <div class="chat-input d-flex align-items-center gap-2">
            <input
              type="text"
              id="messageInput"
              class="form-control"
              placeholder="Type a message..."
            />
            <button class="btn btn-primary px-3" id="sendBtn">
              <i class="bi bi-send text-white"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Backdrop for mobile -->
    <div id="backdrop"></div>

    <!-- Member Modal -->
    <div id="memberModal">
      <h5 id="memberModalTitle">Manage Members</h5>
      <select id="memberSelect" class="form-select mb-2"></select>
      <button id="confirmMemberAction" class="btn btn-primary btn-sm">
        Confirm
      </button>
      <button id="cancelMemberAction" class="btn btn-secondary btn-sm">
        Cancel
      </button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const token = sessionStorage.getItem("token");
      const user = JSON.parse(sessionStorage.getItem("user"));
      let currentGroupId = null,
        currentAction = null;

      if (!token || !user) {
        window.location.href = "/";
      }

      const socket = io({
        auth: { token },
      });

      socket.on("connect_error", (err) => {
        console.error("❌ Socket connection failed:", err.message);
        alert("Session expired or invalid token. Please login again.");
        window.location.href = "/";
      });

      const groupsList = document.getElementById("groupsList");
      const chatHeader = document.getElementById("chatHeader");
      const chatMessages = document.getElementById("chatMessages");

      // Load user's groups
      async function loadGroups() {
        const res = await fetch("/api/groups/my-groups", {
          headers: { Authorization: `Bearer ${token}` },
        });
        const groups = await res.json();
        groupsList.innerHTML = "";
        groups.forEach((g) => {
          const li = document.createElement("li");
          li.className = "group-item";
          li.textContent = g.name;
          li.onclick = () => selectGroup(g.id, g.name);
          groupsList.appendChild(li);
        });
      }

      // Select group
      async function selectGroup(groupId, groupName) {
        currentGroupId = groupId;
        chatHeader.textContent = groupName;
        chatMessages.innerHTML = "";

        // ✅ Join group room on server
        socket.emit("joinGroup", groupId);

        // Check admin
        const resAdmin = await fetch(`/api/groups/${groupId}/isAdmin`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await resAdmin.json();
        document.getElementById("adminActions").style.display = data.isAdmin
          ? "block"
          : "none";

        // Load messages
        const res = await fetch(`/api/group-messages/${groupId}/messages`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const messages = await res.json();
        messages.forEach(renderMessage);
      }

      // Render message
      function renderMessage(msg) {
        const div = document.createElement("div");
        const senderId = msg.userId || msg.senderId;
        const senderName = msg.Sender?.name || "Unknown";
        const isSentByMe = senderId === user.id;

        div.className = "message " + (isSentByMe ? "sent" : "received");
        div.innerHTML = `
            <div class="bubble">
              <strong>${isSentByMe ? "You" : senderName}:</strong>
              <span class="message-text">${msg.content}</span>
            </div>
            <span class="timestamp">${new Date(
              msg.createdAt
            ).toLocaleTimeString()}</span>
          `;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // 📨 Send group message
      async function sendGroupMessage() {
        if (!currentGroupId) return alert("⚠️ Select a group first!");

        const input = document.getElementById("messageInput");
        const content = input.value.trim();
        if (!content) return;

        try {
          // 1️⃣ Save in DB
          const res = await fetch(
            `/api/group-messages/${currentGroupId}/send`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
              },
              body: JSON.stringify({ content }),
            }
          );

          const savedMessage = await res.json();

          // Emit to server (server will assign senderId)
          socket.emit("newGroupMessage", { groupId: currentGroupId, content });

          // 3️⃣ Optimistic UI render (show instantly)
          // renderMessage({
          //   id: savedMessage.id,
          //   userId: user.id,
          //   groupId: currentGroupId,
          //   content,
          //   createdAt: savedMessage.createdAt || new Date(),
          //   Sender: { id: user.id, name: user.name },
          // });
        } catch (err) {
          console.error("❌ Error sending group message:", err);
        }

        input.value = "";
      }

      // 📌 Button click
      document
        .getElementById("sendBtn")
        .addEventListener("click", sendGroupMessage);

      document
        .getElementById("messageInput")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendGroupMessage();
          }
        });

      socket.on("groupMessage", (msg) => {
        if (msg.groupId === currentGroupId) renderMessage(msg);
      });

      // Modal Logic
      const memberModal = document.getElementById("memberModal");
      const memberSelect = document.getElementById("memberSelect");
      const memberModalTitle = document.getElementById("memberModalTitle");

      async function openMemberModal(action) {
        if (!currentGroupId) return alert("⚠️ Select a group first!");
        currentAction = action;
        const members = await (
          await fetch(`/api/groups/${currentGroupId}/members`, {
            headers: { Authorization: `Bearer ${token}` },
          })
        ).json();
        const contacts = await (
          await fetch("/api/contacts/all", {
            headers: { Authorization: `Bearer ${token}` },
          })
        ).json();
        memberSelect.innerHTML = "";
        console.log(members, "hello");

        if (action === "add") {
          memberModalTitle.textContent = "Add Member";
          const memberIds = members.map((m) => m.id);
          contacts
            .filter((c) => !memberIds.includes(c.ContactUser.id))
            .forEach((c) => {
              const opt = document.createElement("option");
              opt.value = c.ContactUser.id;
              opt.textContent = c.ContactUser.name;
              memberSelect.appendChild(opt);
            });
        }
        if (action === "remove") {
          memberModalTitle.textContent = "Remove Member";
          members
            .filter((m) => m.id !== user.id)
            .forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m.id;
              opt.textContent = m.name;
              memberSelect.appendChild(opt);
            });
        }
        if (action === "makeAdmin") {
          memberModalTitle.textContent = "Make Admin";
          members
            .filter((m) => !m.GroupMember.isAdmin)
            .forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m.id;
              opt.textContent = m.name;
              memberSelect.appendChild(opt);
            });
        }
        memberModal.style.display = "block";
      }

      document.getElementById("confirmMemberAction").onclick = async () => {
        const selectedId = memberSelect.value;
        if (!selectedId) return alert("⚠️ Select a user!");

        if (currentAction === "add") {
          await fetch(`/api/groups/${currentGroupId}/add-member`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ newUserId: selectedId }),
          });
        }

        if (currentAction === "remove") {
          await fetch(
            `/api/groups/${currentGroupId}/remove-member/${selectedId}`,
            {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            }
          );
        }

        if (currentAction === "makeAdmin") {
          await fetch(
            `/api/groups/${currentGroupId}/make-admin/${selectedId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            }
          );
        }

        alert("✅ Action completed!");
        memberModal.style.display = "none";
        loadGroups();
      };

      document.getElementById("cancelMemberAction").onclick = () =>
        (memberModal.style.display = "none");
      document.getElementById("addMemberBtn").onclick = () =>
        openMemberModal("add");
      document.getElementById("removeMemberBtn").onclick = () =>
        openMemberModal("remove");
      document.getElementById("makeAdminBtn").onclick = () =>
        openMemberModal("makeAdmin");

      // Load contacts for group creation
      async function loadContactsForGroup() {
        const res = await fetch("/api/contacts/all", {
          headers: { Authorization: `Bearer ${token}` },
        });
        const contacts = await res.json();
        createGroupMembersCheckboxes.innerHTML = "";
        contacts.forEach((c) => {
          const div = document.createElement("div");
          div.className = "form-check";
          div.innerHTML = `
            <input class="form-check-input" type="checkbox" value="${c.ContactUser.id}" id="contact_${c.ContactUser.id}">
            <label class="form-check-label" for="contact_${c.ContactUser.id}">${c.ContactUser.name}</label>
          `;
          createGroupMembersCheckboxes.appendChild(div);
        });
      }

      // Create group
      document
        .getElementById("createGroupForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const groupName = document.getElementById("groupName").value.trim();
          const memberIds = Array.from(
            document.querySelectorAll(
              "#createGroupMembersCheckboxes input:checked"
            )
          ).map((i) => i.value);
          if (!groupName) return;

          await fetch("/api/groups/create", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ name: groupName, memberIds }),
          });

          document.getElementById("groupName").value = "";
          document
            .querySelectorAll("#createGroupMembersCheckboxes input")
            .forEach((i) => (i.checked = false));
          loadGroups();
        });

      // Init
      loadGroups();
      loadContactsForGroup();

      // Sidebar toggle (mobile)
      const sidebar = document.getElementById("sidebar");
      const menuToggle = document.getElementById("menuToggle");
      const backdrop = document.getElementById("backdrop");
      menuToggle.onclick = () => {
        sidebar.classList.add("show");
        backdrop.classList.add("show");
      };
      backdrop.onclick = () => {
        sidebar.classList.remove("show");
        backdrop.classList.remove("show");
      };

      // Close modal when clicking outside of it
      window.addEventListener("click", (e) => {
        const memberModal = document.getElementById("memberModal");
        if (
          memberModal.style.display === "block" &&
          !memberModal.contains(e.target)
        ) {
          memberModal.style.display = "none";
        }
      });
    </script>
  </body>
</html>
