<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SeaTalk - Groups</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      body {
        overflow: hidden;
        font-family: system-ui, sans-serif;
      }

      /* Sidebar */
      #sidebar {
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease;
      }
      .sidebar-header {
        background: #0d6efd;
        color: #fff;
        font-weight: 600;
        padding: 12px;
        text-align: center;
      }
      .group-item {
        background: #f8f9fa;
        padding: 10px;
        margin: 5px 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .group-item:hover {
        background: #e9ecef;
      }

      /* Chat section */
      #chatSection {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      #chatMessages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background: #f9fafb;
      }
      .message {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 18px;
        margin-bottom: 12px;
        font-size: 0.9rem;
      }
      .message.sent {
        background: #dbeafe;
        margin-left: auto;
      }
      .message.received {
        background: #fff;
        border: 1px solid #e5e7eb;
        margin-right: auto;
      }
      .timestamp {
        font-size: 0.7rem;
        color: #6b7280;
        display: block;
        margin-top: 3px;
        text-align: right;
      }

      /* Input */
      .chat-input {
        border-top: 1px solid #e5e7eb;
        background: #fff;
        padding: 8px 12px;
      }
      .chat-input .form-control {
        flex: 1;
        border-radius: 25px;
      }
      .chat-input .btn {
        border-radius: 25px;
      }

      /* Mobile Sidebar */
      #menuToggle {
        display: none;
        cursor: pointer;
        font-size: 1.5rem;
      }
      @media (max-width: 768px) {
        #sidebar {
          position: fixed;
          top: 0;
          left: 0;
          height: 100%;
          width: 70%;
          background: white;
          z-index: 1051;
          transform: translateX(-100%);
        }
        #sidebar.show {
          transform: translateX(0);
        }
        #menuToggle {
          display: block;
        }
        #backdrop {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1050;
        }
        #backdrop.show {
          display: block;
        }
      }
    </style>
  </head>
  <body class="vh-100">
    <div class="container-fluid h-100">
      <div class="row h-100">
        <!-- Sidebar -->
        <div class="col-12 col-md-3 col-lg-3 bg-white p-0" id="sidebar">
          <div class="sidebar-header">SeaTalk Groups</div>
          <div
            id="statusMessage"
            class="text-warning text-center small py-1"
          ></div>

          <ul
            class="list-unstyled flex-grow-1 overflow-auto mb-0"
            id="groupsList"
          ></ul>

          <div class="p-2 border-top">
            <h6 class="fw-bold">Manage Members</h6>
            <select
              id="contactsSelect"
              multiple
              class="form-select mb-2"
            ></select>
            <button
              class="btn btn-sm btn-outline-primary w-100 mb-1"
              id="addMemberBtn"
            >
              <i class="bi bi-person-plus"></i> Add Member
            </button>
            <button
              class="btn btn-sm btn-outline-danger w-100 mb-1"
              id="removeMemberBtn"
            >
              <i class="bi bi-person-dash"></i> Remove Member
            </button>
            <button
              class="btn btn-sm btn-outline-success w-100"
              id="makeAdminBtn"
            >
              <i class="bi bi-shield-check"></i> Make Admin
            </button>
          </div>

          <div class="p-2 border-top">
            <h6 class="fw-bold">Create Group</h6>
            <form id="createGroupForm" class="d-flex flex-column gap-2">
              <input
                type="text"
                id="groupName"
                class="form-control"
                placeholder="Group name..."
                required
              />
              <!-- Updated to checkbox container -->
              <div
                id="createGroupMembersCheckboxes"
                class="mb-2"
                style="max-height: 200px; overflow: auto"
              ></div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> Create Group
              </button>
            </form>
          </div>
        </div>

        <!-- Chat Section -->
        <div class="col d-flex flex-column p-0" id="chatSection">
          <div
            class="d-flex justify-content-between align-items-center bg-primary text-white p-2"
          >
            <i class="bi bi-list" id="menuToggle"></i>
            <span id="chatHeader">Select a group to start chat</span>
            <span></span>
          </div>

          <div id="chatMessages" class="flex-grow-1">
            <div class="text-muted text-center mt-5">
              No messages yet. Start chatting!
            </div>
          </div>

          <!-- Input -->
          <div class="chat-input d-flex align-items-center gap-2">
            <input
              type="text"
              id="messageInput"
              class="form-control"
              placeholder="Type a message..."
            />
            <input type="file" id="fileUpload" hidden />
            <button class="btn btn-primary px-3" id="sendBtn">
              <i class="bi bi-send text-white"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Backdrop for mobile -->
    <div id="backdrop"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const token = sessionStorage.getItem("token");
      const user = JSON.parse(sessionStorage.getItem("user"));
      let currentGroupId = null;

      if (!token || !user) {
        window.location.href = "/";
      }

      const socket = io({ auth: { token } });
      socket.emit("join", { userId: user.id });

      const groupsList = document.getElementById("groupsList");
      const chatHeader = document.getElementById("chatHeader");
      const chatMessages = document.getElementById("chatMessages");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const contactsSelect = document.getElementById("contactsSelect");
      const addMemberBtn = document.getElementById("addMemberBtn");
      const removeMemberBtn = document.getElementById("removeMemberBtn");
      const makeAdminBtn = document.getElementById("makeAdminBtn");
      const createGroupMembersCheckboxes = document.getElementById(
        "createGroupMembersCheckboxes"
      );

      // Load user's groups
      async function loadGroups() {
        try {
          const res = await fetch("/api/groups/my-groups", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const groups = await res.json();
          groupsList.innerHTML = "";
          groups.forEach((g) => {
            const li = document.createElement("li");
            li.className = "group-item";
            li.textContent = g.name;
            li.onclick = () => selectGroup(g.id, g.name);
            groupsList.appendChild(li);
          });
        } catch (err) {
          console.error("‚ùå Failed to load groups", err);
        }
      }

      // Select group and load messages
      async function selectGroup(groupId, groupName) {
        currentGroupId = groupId;
        chatHeader.textContent = groupName;
        chatMessages.innerHTML = "";

        try {
          const res = await fetch(`/api/group-messages/${groupId}/messages`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const messages = await res.json();
          messages.forEach(renderMessage);
        } catch (err) {
          console.error("‚ùå Failed to load messages", err);
        }
      }

      // Render message
      function renderMessage(msg) {
        const div = document.createElement("div");
        const isSentByMe = msg.userId === user.id;

        div.className = "message " + (isSentByMe ? "sent" : "received");
        div.innerHTML = `
    <div><strong>${msg.Sender?.name || "Unknown"}:</strong> ${msg.content}</div>
    <span class="timestamp">${new Date(
      msg.createdAt
    ).toLocaleTimeString()}</span>
  `;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

  // üì® Send group message
  async function sendGroupMessage() {
    if (!currentGroupId) return alert("‚ö†Ô∏è Select a group first!");

    const input = document.getElementById("messageInput");
    const content = input.value.trim();
    if (!content) return;

    try {
      // 1Ô∏è‚É£ Save in DB
      const res = await fetch(`/api/group-messages/${currentGroupId}/send`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token,
        },
        body: JSON.stringify({ content }),
      });

      const savedMessage = await res.json();

      // 2Ô∏è‚É£ Emit via WebSocket (with full data)
      socket.emit("newGroupMessage", {
        id: savedMessage.id,
        senderId: user.id,
        groupId: currentGroupId,
        content,
        createdAt: savedMessage.createdAt || new Date(),
        Sender: { id: user.id, name: user.name }, // for immediate render
      });

      // 3Ô∏è‚É£ Optimistic UI render (show instantly)
      renderMessage({
        id: savedMessage.id,
        userId: user.id,
        groupId: currentGroupId,
        content,
        createdAt: savedMessage.createdAt || new Date(),
        Sender: { id: user.id, name: user.name },
      });

    } catch (err) {
      console.error("‚ùå Error sending group message:", err);
    }

    input.value = "";
  }

  // üìå Button click
  document.getElementById("sendBtn").addEventListener("click", sendGroupMessage);

  // üìå Enter key send (Shift+Enter = newline)
  document.getElementById("messageInput").addEventListener("keypress", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendGroupMessage();
    }
  });

  // üì• Listen for incoming group messages
  socket.on("groupMessage", (msg) => {
    if (msg.groupId === currentGroupId) {
      renderMessage(msg);
    }
  });

      // Load contacts for group creation (checkboxes)
      async function loadContactsForGroup() {
        try {
          const res = await fetch("/api/contacts/all", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const contacts = await res.json();

          createGroupMembersCheckboxes.innerHTML = "";
          contacts.forEach((c) => {
            const div = document.createElement("div");
            div.className = "form-check";
            div.innerHTML = `
              <input class="form-check-input" type="checkbox" value="${c.ContactUser.id}" id="contact_${c.ContactUser.id}">
              <label class="form-check-label" for="contact_${c.ContactUser.id}">${c.ContactUser.name}</label>
            `;
            createGroupMembersCheckboxes.appendChild(div);
          });
        } catch (err) {
          console.error("‚ùå Failed to load contacts for group", err);
        }
      }

      // Create group
      document
        .getElementById("createGroupForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const groupName = document.getElementById("groupName").value.trim();
          const memberIds = Array.from(
            document.querySelectorAll(
              "#createGroupMembersCheckboxes input:checked"
            )
          ).map((i) => i.value);

          if (!groupName) return;

          try {
            await fetch("/api/groups/create", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ name: groupName, memberIds }),
            });

            document.getElementById("groupName").value = "";
            document
              .querySelectorAll("#createGroupMembersCheckboxes input")
              .forEach((i) => (i.checked = false));
            loadGroups();
          } catch (err) {
            console.error("‚ùå Failed to create group", err);
          }
        });

      // Load contacts for member management
      async function loadContacts() {
        try {
          const res = await fetch("/api/contacts/all", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const contacts = await res.json();
          contactsSelect.innerHTML = "";
          contacts.forEach((c) => {
            const opt = document.createElement("option");
            opt.value = c.ContactUser.id;
            opt.textContent = c.ContactUser.name;
            contactsSelect.appendChild(opt);
          });
        } catch (err) {
          console.error("‚ùå Failed to load contacts", err);
        }
      }

      // Add/Remove/Make Admin
      addMemberBtn.onclick = async () => {
        const members = Array.from(contactsSelect.selectedOptions).map(
          (opt) => opt.value
        );
        if (!currentGroupId || !members.length) return;
        for (const userId of members) {
          await fetch(`/api/groups/${currentGroupId}/add-member`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ newUserId: userId }),
          });
        }
      };
      removeMemberBtn.onclick = async () => {
        const members = Array.from(contactsSelect.selectedOptions).map(
          (opt) => opt.value
        );
        if (!currentGroupId || !members.length) return;
        for (const userId of members) {
          await fetch(`/api/groups/${currentGroupId}/remove-member/${userId}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
        }
      };
      makeAdminBtn.onclick = async () => {
        const members = Array.from(contactsSelect.selectedOptions).map(
          (opt) => opt.value
        );
        if (!currentGroupId || !members.length) return;
        for (const userId of members) {
          await fetch(`/api/groups/${currentGroupId}/make-admin/${userId}`, {
            method: "PUT",
            headers: { Authorization: `Bearer ${token}` },
          });
        }
      };

      // Load everything
      loadGroups();
      loadContacts();
      loadContactsForGroup();

      // Sidebar toggle (mobile)
      const sidebar = document.getElementById("sidebar");
      const menuToggle = document.getElementById("menuToggle");
      const backdrop = document.getElementById("backdrop");

      menuToggle.onclick = () => {
        sidebar.classList.add("show");
        backdrop.classList.add("show");
      };
      backdrop.onclick = () => {
        sidebar.classList.remove("show");
        backdrop.classList.remove("show");
      };
    </script>
  </body>
</html>
